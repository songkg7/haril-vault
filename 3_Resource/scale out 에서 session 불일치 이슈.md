---
title: "scale out 에서 session 불일치 이슈"
date: 2022-12-27 23:29:00 +0900
aliases: 
tags: [session, load-balancing]
categories: 
---

## Overview

[[NginX]] 등을 사용한 load balancing 등 여러 대의 서버를 사용할 때 발생할 수 있는 세션 동기화 이슈에 대해 살펴봅니다.

## Background

여러 대의 서버에서 클라이언트의 요청을 처리하게 될 경우, 인증을 받은 클라이언트가 인증 정보를 전달해준 서버와 다른 서버로 인증 이후 요청을 보내게 되면, 요청을 받은 서버는 클라이언트의 개런티를 알 수 없다. 여기서 세션 불일치 이슈가 발생하기에 여러 대의 서버를 운영하는 경우 반드시 동기화 방법을 마련해야 한다.

## Solution

- Sticky session
- Session clustering
- Session store

### Sticky Session

최종 요청을 받은 서버가 해당 클라이언트에 대한 요청을 모두 책임지는 형태. 대표적인 방법으로 cookie 에 이용 서버를 저장하는 방법이 있다.

가장 구현이 간단하고 응답속도도 빠르다. 다만 사용자가 접속해야하는 서버가 정해져있기 때문에 트래픽 몰림 문제에서 완전히 자유로울 순 없고, 서버에 장애가 발생하는 경우 해당 서버를 이용하고 있던 사용자의 세션 정보를 잃게 된다.

### Session Clustering

세션 정보를 TCP Socket 으로 서버끼리 공유하는 방법.

사용자가 같은 클러스러로 접속한다면 동일한 세션 데이터를 받을 수 있도록 보장할 수 잇다. 한서버에 고정되지 않으므로 트래픽 쏠림 문제를 해결할 수 있고, 개별 서버가 터지더라도 세션 정보를 잃지 않는다.

반대로 세션 데이터가 저장될 때마다 모든 서버에 해당 데이터가 입력되어야 하므로(동기화 과정), 성능 저하가 올 수 있고 개별 서버 안에서도 각 서버의 세션 정보가 아닌 동일 클러스터의 모든 세션 정보를 저장해야하므로 많은 메모리를 요구한다. 동기화 과정에서 시간차로 인해 예상하지 못한 문제가 발생할 수 있다.

### Session Storage

최초 요청을 받은 서버가 세션 정보를 생성해서 외부 저장소에 저장한다. Redis 같은 서비스를 이용할 수 있다.

Sticky session, Session clustering 의 단점을 보완한다. 하지만 모든 세션 정보를 세션 저장소가 관리하기 때문에 세션 저장소에 장애가 생기지 않도록 주의해야 한다.

## Reference

[세션 불일치 이슈](https://velog.io/@sweet_sumin/세션-불일치-이슈)
