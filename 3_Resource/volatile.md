---
title: volatile
date: 2024-03-21T15:24:00
aliases: 
tags:
  - java
  - synchronize
  - cpu
  - cache
  - concurrency
categories: 
updated: 2025-01-07T00:35
---

## Java 에서의 volatile

[[Java]] 에서 volatile 은 속도보다는 엄격한 메모리 휘발성 제어에 중점을 둔 키워드이다.

멀티 스레드 환경에서 공유되는 변수가 있을 때, 변수를 read / write 할 때 캐시를 이용하게 되면 다른 스레드에서 값을 변경해도 변경된 값을 읽지 못하는 경우가 생긴다. 이때 volatile 키워드를 사용하면 메모리에 캐싱하지 않고 바로 메모리에 접근하여 값을 읽고 쓰기 때문에 항상 최신의 값을 확인할 수 있다.

하지만 volatile 키워드는 단순히 read / write 를 한다는 것만으로 충분한 것은 아니다. 멀티 스레드 환경에서 하나의 변수를 변경할 때 아래와 같은 문제점이 발생할 수 있다.

* Race condition
* Read-modify-write
* Lost update

이러한 문제점이 발생하는 이유는 다음과 같다.

1. CPU 는 데이터를 캐시로 가져올 때 여러 개의 워크로드(Workload) 를 처리하기 위해 성능을 최적화시켰기 때문이다.
2. Java 는 일반적으로 프로그래밍 언어로서 보편적으로 사용되지만 멀티 스레드 환경에서 성능을 최적화시키는 일반적인 기본 원칙은 아니다.
3. 멀티 스레드 환경에서 캐시된 데이터는 동기화되지 않는다.
4. 멀티 스레드 환경에서 여러 개의 CPU 는 동일한 메모리 주소를 가질 수 있다.

CPU 는 캐시에 데이터를 저장하고, 이 데이터를 사용할 때마다 캐시의 데이터를 변경한다. 즉, 실제 메모리 주소에 있는 값을 변경하는 것이 아니라 캐시된 값이 변경되는 것이다. 그리고 다른 CPU 가 실제 메모리 주소에 있는 값을 읽으려고 할 때 다른 CPU 가 캐시한 값을 읽게 되면 최신의 값을 읽지 못하게 되는 것이다.

Java 에서는 이러한 문제점을 해결하기 위해 synchronized 키워드와 volatile 키워드를 사용한다.

synchronized 키워드는 코드 블럭을 임계 영역으로 설정하여 해당 코드 블럭을 실행할 때 해당 객체가 lock 을 걸어 다른 스레드들은 해당 코드 블럭이 실행될 때까지 대기하게 한다. 이때 synchronized 키워드로 임계 영역을 지정하면 공유 변수의 일관성과 안전성을 보장할 수 있다.

volatile 키워드는 변수를 read / write 할 때 캐시를 이용하지 않고 메모리에 직접 접근하여 값을 읽고 쓰게 된다. 이때 volatile 키워드를 사용하면 공유 변수의 일관성은 보장할 수 있지만 안전성은 보장하지 못한다.

Java 에서는 synchronized 를 통해 안전한 멀티 스레드 환경을 구성할 수 있지만, synchronized 를 사용하면 다른 스레드들은 해당 코드 블럭이 실행될 때까지 대기하게 되므로 성능상 큰 문제가 발생할 수 있다. 그래서 적절한 키워드 선택이 중요하다.

## Reference

- https://a1010100z.tistory.com/199
