---
title: 데이터베이스 복제
date: 2023-10-01 21:22:00 +0900
aliases: 
tags:
  - database
  - distribute
  - reliability
  - book
categories: 
updated: 2024-09-23 09:14:40 +0900
related: "[[Database|Database]]"
---

# 복제

수많은 서버로 구성된 분산 환경에서는 [[Database|DB]] 또한 고가용성 보장을 위해 분산 처리할 수 있어야 한다. 일반적으로 같은 데이터베이스를 여러 대로 구성하여 이 문제를 해결하며 이를 복제라고 한다.

[[Database|DB]] 복제를 구현하는 방법은 여러가지가 있다.

## 리더 기반 복제

### 복제 로그 구현

1. 구문 기반 복제
2. 쓰기 전 로그 배송
    - Write-ahead log([[WAL]])
    - 로그는 데이터베이스의 모든 쓰기를 포함하는 바이트 열이다. 이 로그를 사용하여 팔로워 노드에서 복제 서버를 구축할 수 있다.
    - 로그가 제일 저수준의 데이터 정보를 포함하기 때문에 저장소 엔진과 밀접하게 엮이고, 리더와 팔로워의 의존성을 강하게 한다. 이는 무중단 업데이트를 어렵게 한다.
3. 논리적 로그 복제
    - [[MySQL]] binlog
    - 별개의 로그 형식을 사용하는 방법이다. 이 방법은 외부 애플리케이션이 파싱하기 더 쉬우며 외부 시스템에 데이터베이스 내용을 전송하고자 할 때([[Change Data Capture|CDC]]) 유용하다.
4. 트리거 기반 복제

## 복제 지연 문제

### 자신이 쓴 내용 읽기

방금 작성한 내용에 대해서 다시 조회했을 때 아직 팔로워에 리더의 변경사항이 반영되지 않았을 경우 변경사항이 사라진 것처럼 보이는 다소 불쾌한 경험을 할 가능성이 있다. 이런 상황에서는 **쓰기 후 읽기 일관성**이 필요하다.

- 사용자가 수정한 내용을 읽을 때는 리더에서 읽는다. 예를 들어 SNS 에서는 사용자 프로필 정보는 보통 프로필 소유자만 편집할 수 있다. 따라서 항상 사용자 소유의 프로필은 리더에서 읽고 다른 사용자의 프로필은 팔로워에서 읽는 규칙을 사용함으로서 간단하게 달성할 수 있다.
- 마지막 갱신 시각을 찾아서 마지막 갱신 후 1분 동안은 리더에서 모든 읽기를 수행한다. 또한 팔로워에서 복제 지연을 모니터링해 리더보다 1분 이상 늦은 모든 팔로워에 대한 질의를 금지할 수 있다.
- 클라이언트는 가장 최근 쓰기의 타임스탬프를 기억할 수 있으므로, 복제 서버가 아직 최신 내용이 아닌 경우에는 다른 복제 서버에서 처리하거나 따라잡을 때까지 질의를 대기하게 할 수 있다.

여러 디바이스 간에 쓰기 후 읽기 일관성이 제공되어야 한다면 문제는 더 복잡해진다.

- 다른 디바이스에서 발생한 갱신을 알 수 없어지기 때문에, 갱신 시간으로 접근했던 방식은 이제 중앙집중적으로 관리되어야 한다.
- 복제 서버가 여러 데이터 센터간에 분산되어 있다면, 사용자의 요청이 동일한 데이터 센터로 라우팅되는 방법을 먼저 고민해야 한다.

### 단조 읽기(monotonic read)

> 시간이 거꾸로 흐르는 현상

예를 들면 다른 사용자의 댓글을 이미 확인했는데, 새로고침하는 경우 이 댓글이 없어지는 현상이 있을 수 있다.

단조 읽기는 이런 종류의 이상 현상이 발생하지 않음을 보장한다. 달성하는 방법은 각 사용자의 읽기가 항상 동일한 복제 서버에서 수행되게끔 하는 것이다. 예를 들어 임의 선택보다는 사용자 ID 의 해시를 기반으로 복제 서버를 선택한다. [[Consistent Hashing|안정 해시]]를 참고해보자.

### 일관된 순서로 읽기(Consistent Prefix Read)

> 인관성의 위반 우려

일련의 쓰기가 특정 순서로 발생한다면 이 쓰기를 읽는 모든 사용자는 같은 순서로 쓰여진 내용을 보게 됨을 보장해야 한다.

이는 파티셔닝된 데이터베이스에서 발생하는 특징적인 문제다.

이 문제는 [[Concurrency|동시성]]과 밀접한 관련이 있으며, 쓰기가 이전 읽기의 버전 번호를 포함하면 쓰기가 수행되기 이전 상태를 알 수 있다.

### 복제 지연을 위한 해결책

[[Transaction|Transaction]]

## 다중 리더 복제

### 사용 사례

#### 다중 데이터센터 운영

#### 오프라인 작업을 하는 클라이언트

#### 협업 편집

### 쓰기 충돌 다루기

#### 동기 대 비동기 충돌 감지

#### 충돌 회피

#### 일관된 상태 수렴

## 리더 없는 복제

### 노드가 다운됐을 때 데이터베이스에 쓰기
