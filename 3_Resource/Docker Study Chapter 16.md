---
title: Docker Study Chapter 16
date: 2023-11-24T18:44:00
aliases: 
tags:
  - docker
  - study
  - buildx
categories: 
updated: 2025-01-07T00:35
---

# Multi Platform Support

## 다중 아키텍처 이미지가 중요한 이유

실제 운영환경은 다양한 가상 머신으로 구성되기도 한다. 도커 이미지가 이들 가상 머신을 지원하지 못한다면 결국 특정 플랫폼에 종속되게 된다.

도커는 시스템 정보를 이용해 환경에 맞는 이미지를 내려받으며 이 과정에서 이미지를 곧바로 사용할 수 있도록 레이어의 압축을 푸는 최적화 과정도 포함된다. 하지만 이 과정은 이미지의 아키텍처와 현재 컴퓨터의 아키텍처가 일치해야만 한다.

> 기본적인 원칙은 이미지의 아키텍처가 도커 엔진의 아키텍처와 일치해야 한다는 것이다

## 다중 아키텍처 이미지를 만들기 위한 Dockerfile 스크립트

- 멀티 스테이지 [[Dockerfile]] 스크립트를 이용해 컨테이너에서 소스 코드를 빌드하고 패키징
- Dockerfile 스크립트를 여러 개 만들고 빌드하는 방식으로 여러 플랫폼을 지원할 수 있다
- 단일 스크립트로도 작성할 수 있지만 **모든 운영체제에서 공통으로 사용할 수 있는 명령어만 사용**해야 한다

## 다중 아키텍처 이미지를 레지스트리에 푸시하기

다양한 아키텍처의 이미지를 빌드했지만, 이들 이미지를 다중 아키텍처 이미지로 만들려면 매니페스트와 함께 이들 이미지를 레지스트리에 푸시해야 한다.

> [!info] Manifest?
> 메니페스트란 여러 개의 변종 이미지를 하나의 이미지 태그로 묶는 메타데이터를 말한다.

```bash
docker image tag diamol/ch16-folder-list:linux-amd64 "$dockerId/ch16-folder-list:linux-amd64"
docker image tag diamol/ch16-folder-list:linux-arm64 "$dockerId/ch16-folder-list:linux-arm64"
docker image tag diamol/ch16-folder-list:linux-arm "$dockerId/ch16-folder-list:linux-arm"

docker image push "$dockerId/ch16-folder-list"
```

`docker manifest` 명령을 사용해 로컬에서 매니페스트를 사용하고 레지스트리에 푸시할 수 있다. 이 명령을 사용하면 이미지가 어떤 아키텍처를 지원하는지도 image 를 pull 하지 않고도 확인해볼 수 있다.

```bash
docker manifest inspect diamol/base
```

매니페스트 리스트는 이미지 태그의 목록 같은 것이다. 그리고 매니페스트 리스트의 이름이 다중 아키텍처 이미지의 이름이 된다.

## 도커 Buildx 를 사용해 다중 아키텍처 이미지 빌드하기

### buildx 의 특징

- `docker build` 의 확장판이라고 생각하면 되며, 최적화된 빌드 엔진이 적용돼 빌드 성능이 뛰어나다
- `docker build` 명령을 그대로 대체할 수 있다
- 크로스 플랫폼 빌드를 지원한다
- 도커 컨텍스트와 통합돼 있기 때문에 한 번의 명령으로 여러 대의 서버에서 빌드를 진행할 수 있다
- 단일 파일로된 Dockerfile 스크립트만 지원한다
- 리눅스 이미지의 아키텍처별 변종 이미지를 만드려는 경우에 유용하다
- Window container 는 지원하지 않는다 (아직 지원되지 않는 것으로 보임 23.11.23)

빌드팜을 구성하여 다중 아키텍처 이미지 빌드를 한 번에 실행할 수 있다. buildx 는 여러 노드에 한 꺼번에 Dockerfile 스크립트와 빌드 컨텍스트 디렉터리를 보내 병렬로 빌드를 진행한다.

**현재로서는 윈도 컨테이너를 꼭 지원할 필요가 없다면 다중 아키텍처 이미지 빌드에 Buildx 를 사용하는 것이 가장 좋다.**

## 개발 로드맵과 다중 아키텍처 이미지

Dockerfile 스크립트에 두 가지 사항만 미리 적용해 놓는다면, 큰 어려움 없이 다중 아키텍처 이미지로 전환할 수 있다.

- FROM 인스트럭션에 항상 다중 아키텍처 이미지를 기반 이미지로 지정한다.
- RUN, CMD 인스트럭션에는 특정 운영체제에서만 사용되는 명령어를 사용하지 않는다.
    - 배포 과정 혹은 애플리케이션 시동 과정이 복잡하다면, 이 과정을 별도의 유틸리티 애플리케이션으로 만들고 별도의 빌드 단계에서 이 유틸리티를 컴파일한다.

[[Docker]] 허브에 게시된 모든 공식 이미지는 다중 아키텍처 이미지이므로 공식 이미지를 기반 이미지로 사용하는 것이 좋다.

모든 대상 아키텍처를 제공하는 매니지드 빌드 서비스는 아직 없다. 일부 서비스가 윈도와 리눅스를 모두 지원하지만 ARM 아키텍처는 직접 대책을 마련해야 한다. AWS 에서 리눅스, 윈도, ARM 가상 머신에 도커를 설치해 사용하면 비교적 저렴한 비용에 빌드팜을 꾸릴 수 있다.

> [!TIP]
> 빌드 파이프라인에서 AWS CLI 를 사용하면 빌드가 필요한 순간에만 빌드팜을 running 상태로 만들 수 있다. 이렇게 구성하면 빌드를 사용하지 않을 때는 EC2 resource 를 stop 하여 비용이 발생하지 않게 할 수 있으므로, 굉장히 적은 비용으로 빌드팜을 구성할 수 있다.

중요한 점은 **언젠가 다른 아키텍처를 지원해야 할 날이 온다**는 사실이니 Dockerfile 스크립트가 항상 변경에 유연하도록 유지하는 법을 알아둘 필요가 있다.
