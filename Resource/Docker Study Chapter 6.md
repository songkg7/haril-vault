---
title: Docker Study Chapter 6
date: 2023-10-21 15:45:00 +0900
aliases: 
tags:
  - docker
  - study
  - volume
  - persistence
categories: Docker
updated: 2023-10-21 16:48:01 +0900
---

# Chapter 6

## 도커 볼륨을 이용한 퍼시스턴트 스토리지

---

애플리케이션에 전혀 상태가 없을 수는 없다. 영속성이나 성능 향상을 위해 디스크를 사용하는 컴포넌트가 있어야하고 이 컴포넌트 역시 컨테이너에서 실행된다.

[[Docker volume|Docker volume]]

---

### 컨테이너 속 데이터가 사라지는 이유

컨테이너의 파일 시스템은 단일 디스크지만, 여러 출처로 구성된 가상 파일 시스템이다.

이 출처는 기본적으로 이미지 레이어와 컨테이너의 기록 가능 레이어로 구성되는데, 이미지 레이어는 모든 컨테이너가 공유하지만 기록 가능 레이어는 컨테이너마다 다르다.

![[IMG_2429.jpeg]]

- 기존 이미지 레이어에 있는 파일을 수정할 수도 있으며, **기록 중 복사(copy-on-write)** 라고 한다.
    - 기록 가능 레이어로 파일을 복사해온 뒤, 이 파일을 수정하는 방식으로 동작한다.

---

### 컨테이너 파일 시스템의 생애주기

- 컨테이너의 파일은 컨테이너의 생애주기를 공유한다.
- 컨테이너가 삭제되면 내부의 파일도 함께 삭제된다.

---

## 도커 볼륨을 사용하는 컨테이너

---

### 도커 볼륨이란

- 도커에서 스토리지를 다루는 단위
- 컨테이너와 독립적으로 존재
- 별도의 생애주기를 갖음
- 컨테이너에 연결할 수 있으며, 이 경우 컨테이너 파일 시스템의 한 디렉터리가 됨

---

### 사용법

- CLI 를 통한 수동 관리
- VOLUME 인스트럭션을 이용한 관리

---

### 특징

- 외장하드처럼 관리할 수 있다
- 새로 생성해서 사용할 수도 있고, 기존의 볼륨을 공유할 수도 있다

---

### 주의점

- 볼륨은 컨테이너 간 파일 공유보다는 업데이트 간 상태를 보존하기 위해 사용해야 한다
- 이미지에서 정의하는 것보다는 명시적으로 관리하는 편이 낫다
- VOLUME 인스트럭션과 `--volume` 플래그는 별개 기능이다
- VOLUME 인스트럭션은 일종의 안전장치로써 유용하다
    - 데이터가 유실되지 않음을 보장할 수 있다

---

모든 컨테이너는 도커가 다양한 출처로부터 모아 만든 단일 가상 디스크로 구성된 파일 시스템을 갖는다. 이 파일 시스템을 **유니언 파일 시스템(Union File System)** 이라고 한다.

컨테이너는 유니언 파일 시스템을 통해 물리적 위치가 서로 다른 파일과 디렉터리에 마치 단일 디스크를 사용하듯 접근할 수 있다.

---

## 파일 시스템 마운트

---

- 호스트의 파일 시스템에 컨테이너가 직접 접근할 수 있게 하고, 그 반대도 가능
- 컨테이너와 직접 공유되므로, 컨테이너를 빌드하지 않고 내용을 바꾸는데 사용할 수 있다
    - 예) 설정파일

---

### 파일 시스템 마운트의 한계점

- 마운트 대상 디렉터리가 이미 존재하고 이미지 레이어에 이 디렉터리의 파일이 포함돼 있다면, 마운트의 원본 디렉토리가 기존 디렉터리를 완전히 대체한다. 즉 이미지에 원래 포함돼 있던 파일은 사용할 수 없다.
- [[운영체제 (Operating system)]]별로 다른 동작이 존재한다.
- 분산 파일 시스템을 사용할 경우, 지원되지 않는 기능으로 인해 에러가 발생하거나 애플리케이션이 정상적으로 동작하지 않을 수 있다.

---

### 컨테이너의 스토리지를 구성할 때 고려해야할 일반론

- 기록 가능 레이어: 비용이 비싼 계산이나 데이터의 캐싱 등 단기 저장에 적합. 컨테이너가 삭제되면 데이터는 유실된다.
- 로컬 바인드 마운트: 호스트 컴퓨터와 컨테이너 간 데이터를 공유하기 위해 사용
- 분산 바인드 마운트: 네트워크 스토리지와 컨테이너 간에 데이터를 공유하기 위해 사용
- 볼륨 마운트: 컨테이너와 도커 객체인 볼륨 간에 데이터를 공유하기 위해 사용. 이전 버전의 컨테이너의 데이터를 그대로 유지 가능.
- 이미지 레이어: 컨테이너의 초기 파일 시스템을 구성. 읽기 전용이며 여러 컨테이너가 공유한다.
