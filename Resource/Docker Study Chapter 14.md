---
title: Docker Study Chapter 14
date: 2023-11-16 16:37:00 +0900
aliases: 
tags:
  - docker
  - study
categories: 
updated: 2023-11-18 12:31:26 +0900
---

## 업그레이드와 롤백을 이용한 업데이트 자동화

빌드에 대한 신뢰감을 쌓는 것이 중요하다. 핵심은 애플리케이션 헬스 체크.

실습은 아래 사이트를 활용하면 편리하다.

https://labs.play-with-docker.com

### 도커를 사용한 애플리케이션 업그레이드 프로세스

정해진 주기 없이 수시로 애플리케이션을 업데이트하는 데 익숙해져야 한다. 이 과정을 자동화하여 빌드에 신뢰감이 생길 수 있도록 하고 바로바로 배포에 포함시킬 수 있도록 해야 한다.

이 과정의 핵심은 애플리케이션 헬스 체크다. 헬스 체크는 애플리케이션이 자기 수복성을 가질 수 있게 하고 안전한 업데이트와 롤백도 가능하게 한다.

이후는 실습.

### 운영 환경을 위한 롤링 업데이트 설정하기

롤링 업데이트 과정을 세세하게 조율하여 업데이트 과정에 신뢰감을 더할 수 있다. 완전히 레플리카가 정상 동작한 이후 다음 레플리카를 교체하는 방식 등이다.

### 서비스 롤백 설정하기

대개 롤백은 자동으로 진행된다. 롤링 업데이트 설정을 잘해두었다면, '업데이트가 끝났는데 신규 기능이 나타나지 않네' 하고 조금 이상한 것을 깨닫고 말 뿐, 더 이상의 일은 일어나지 않는다.

배포 실패가 좋은 일은 아니지만, 자동으로 롤백된다면 애플리케이션이 장애를 일으키지는 않을 것이다. 또한 롤백은 가능한 한 신속하게 이전 상태로 돌아가는 것이 낫다. 서비스 처리 용량이 저하된 상태를 길게 지속하지 않기 위해서이다.

### 클러스터의 중단 시간

오케스트레이션 도구는 여러 대의 컴퓨터를 묶어 하나의 강력한 클러스터로 만든다. 결국 실제로 컨테이너를 실행하는 것은 각각의 컴퓨터이므로 디스크, 네트워크, 전원 등의 이유로 중단 시간이 발생할 수 있다. 대부분의 클러스터는 애플리케이션을 그대로 실행할 수 있지만, 적극적인 조치가 필요한 경우도 있다.

- drain 은 노드를 유지보수 모드로 전환한다.

drain 모드가 되면 해당 노드에서는 레플리카가 종료되고 새로운 레플리카를 실행하지도 않는다. 유지보수 작업이 완료된 이후 다시 클러스터에 합류 시켜서 동작하게 할 수 있다. ([[Kubernetes]] 에도 같은 기능이 있음)

### 스웜 클러스터의 고가용성

지역을 아우르는 거대한 규모의 장애에도 애플리케이션이 계속 동작해야 할 필요가 있다면, 이를 실현할 수 있는 방법은 클러스터를 여러 개 구성하는 것뿐이다. 네트워크 지연으로 정상 노드가 계속 재배치되며 문제를 악화시키는 최악의 시나리오보다는 통제하기 쉽다.
