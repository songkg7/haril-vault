---
title: Docker Study Chapter 17
date: 2023-12-02 17:32:00 +0900
aliases: 
tags:
  - docker
  - study
  - optimize
categories: 
updated: 2023-12-02 18:52:13 +0900
---

# 도커 이미지 최적화하기: 보안, 용량, 속도

## 도커 이미지를 최적화하는 방법

```bash
# 이미지와 컨테이너 등이 점유하는 실제 디스크 용량 확인하기
docker system df
```

- 꼭 필요한 파일만 이미지에 포함시킨다.
- 후순위 인스트럭션에서 이전 인스트럭션의 일부를 제거한다고 해서 이미지 용량이 줄어들지 않는다.
- 도커의 빌드 과정은 엔진에 빌드 컨텍스트(빌드를 실행한 디렉토리)를 압축하고 Dockerfile 스크립트를 함께 보내면서 시작된다.
- `.dockerignore` 파일에 불필요한 디렉터리나 파일 목록을 기재하면 빌드 컨텍스트에서 제외할 수 있다.

## 좋은 기반 이미지를 고르는 법

- [[curl]] 같은 도구가 이미지에 포함되어 있다면 보안 취약점이 될 수 있다.
- 크기가 작은 변종 이미지부터 검토한다.
- 애플리케이션 빌드에 필요한 도구를 포함하지 않아야 한다. 빌드 과정은 이미지를 망가뜨릴 수 있다.
- Anchore, Aqua 등의 이미지 검사 도구를 활용한다.

## 이미지 레이어 수와 이미지 크기는 최소한으로

- 꼭 필요한 것만 포함하는 이미지를 만든다.
- 여러개의 인스트럭션은 최대한 하나로 합친다.
- 디버깅을 위해 여러개로 분할하고 쓸 수 있지만, 항상 마지막에는 최적화 과정을 진행해야 한다.
- 앞서 이야기했지만, 이미지에 불필요한 파일을 포함한 뒤에 삭제하는 것은 도움이 되지 않는다.

## 멀티 스테이지 빌드를 한 단계 업그레이드하기

- 멀티 스테이지 빌드는 특정 단계까지만 이미지를 빌드할 수 있다.
- 인스트럭션을 합치느라 복잡하게 명령어를 줄일 필요가 없다.
- 불필요한 요소까지 캐싱되지 않도록 주의해야 한다.
- 정확한 버전을 명시해 실행 또는 업데이트 대상을 명확히 한다.

## 최적화가 중요한 이유

- 기반 이미지를 잘 고르기. 골든 이미지를 갖출 수 있는게 이상적이다.
- 아주 간단한 애플리케이션이 아니라면 멀티 스테이지 빌드를 적용한다.
- 불필요한 패키지나 파일을 포함시키지 말고, 레이어 크기를 최소한으로 유지한다.
- [[Dockerfile]] 스크립트의 인스트럭션은 자주 수정하는 순서대로 뒤에 오도록 배치해 캐시를 최대한 활용한다.
